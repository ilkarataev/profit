# ๐ Universal Application Deployment

ะฃะฝะธะฒะตััะฐะปัะฝะฐั ัะธััะตะผะฐ ะดะตะฟะปะพั ะดะปั ะฟัะธะปะพะถะตะฝะธะน Avito ะธ HH ั ะฟะพะดะดะตัะถะบะพะน ะผะฝะพะถะตััะฒะตะฝะฝัั ะบะปะธะตะฝัะพะฒ.

## ๐ ะะฑะทะพั

ะญัะฐ ัะธััะตะผะฐ ะฟะพะทะฒะพะปัะตั:
- ะะตะฟะปะพะธัั ะฟัะธะปะพะถะตะฝะธั Avito ะธ HH ะฒ ะพะดะฝะพะผ Docker Compose
- ะะพะดะดะตัะถะธะฒะฐัั ะผะฝะพะถะตััะฒะตะฝะฝัั ะบะปะธะตะฝัะพะฒ ั ะธะทะพะปะธัะพะฒะฐะฝะฝัะผะธ ะบะพะฝัะตะนะฝะตัะฐะผะธ
- ะัะฟะพะปัะทะพะฒะฐัั ะพะฑัะธะน Redis ะดะปั ะฒัะตั ัะตัะฒะธัะพะฒ
- ะะฒัะพะผะฐัะธัะตัะบะธ ะฝะฐัััะฐะธะฒะฐัั Traefik ะดะปั ะผะฐัััััะธะทะฐัะธะธ
- ะฃะฟัะฐะฒะปััั ัะตะบัะตัะฐะผะธ ัะตัะตะท GitHub Secrets

## ๐๏ธ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ   Traefik       โ    โ   Portainer     โ    โ   Redis         โ
โ   (Reverse      โ    โ   (Docker UI)   โ    โ   (Shared)      โ
โ    Proxy)       โ    โ                 โ    โ                 โ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
         โ                       โ                       โ
         โโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโ
                                 โ
         โโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโ
         โ                       โ                       โ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ   Avito API     โ    โ   HH API        โ    โ   Client Data   โ
โ   :3030         โ    โ   :3999         โ    โ   (Isolated)    โ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
```

## ๐ง ะะฐัััะพะนะบะฐ

### 1. GitHub Secrets

ะะพะฑะฐะฒััะต ัะปะตะดัััะธะต ัะตะบัะตัั ะฒ ะฒะฐั GitHub ัะตะฟะพะทะธัะพัะธะน:

```
SSH_PRIVATE_KEY          - ะัะธะฒะฐัะฝัะน SSH ะบะปัั ะดะปั ะดะพัััะฟะฐ ะบ ัะตัะฒะตัั

# ะะปั ะบะฐะถะดะพะณะพ ะบะปะธะตะฝัะฐ ะฝัะถะฝั ัะพะปัะบะพ ัะตะบัะตัะฝัะต ะดะฐะฝะฝัะต:
# ะะฐะฟัะธะผะตั, ะดะปั ะบะปะธะตะฝัะฐ "client1":
CLIENT1_HH_CLIENT_SECRET - Client Secret ะดะปั HH API
CLIENT1_SENTRY_DSN       - Sentry DSN (ะพะฟัะธะพะฝะฐะปัะฝะพ)

# ะะปั ะบะปะธะตะฝัะฐ "client2":
CLIENT2_HH_CLIENT_SECRET - Client Secret ะดะปั HH API
CLIENT2_SENTRY_DSN       - Sentry DSN (ะพะฟัะธะพะฝะฐะปัะฝะพ)
```

### 1.1. GitHub Variables

ะะพะฑะฐะฒััะต ัะปะตะดัััะธะต ะฟะตัะตะผะตะฝะฝัะต(variables) ะฒ ะฒะฐั GitHub ัะตะฟะพะทะธัะพัะธะน:

```
# ะะปั ะบะฐะถะดะพะณะพ ะบะปะธะตะฝัะฐ ะฝัะถะฝั ะฟะตัะตะผะตะฝะฝัะต(variables) ั ะฟัะตัะธะบัะพะผ:
# ะะฐะฟัะธะผะตั, ะดะปั ะบะปะธะตะฝัะฐ "client1":
CLIENT1_AVITO_API_URL    - ะะฐะทะพะฒัะน URL ะดะปั Avito API (ะฟะพ ัะผะพะปัะฐะฝะธั: https://api.avito.ru)
CLIENT1_HH_API_URL       - ะะฐะทะพะฒัะน URL ะดะปั HH API (ะฟะพ ัะผะพะปัะฐะฝะธั: https://api.hh.ru)
CLIENT1_HH_CLIENT_ID     - Client ID ะดะปั HH API
CLIENT1_WEBHOOK_URL_AVITO - URL ะดะปั webhook ัะฒะตะดะพะผะปะตะฝะธะน Avito
CLIENT1_WEBHOOK_URL_HH   - URL ะดะปั webhook ัะฒะตะดะพะผะปะตะฝะธะน HH
CLIENT

# ะะปั ะบะปะธะตะฝัะฐ "client2":
CLIENT2_AVITO_API_URL    - ะะฐะทะพะฒัะน URL ะดะปั Avito API
CLIENT2_HH_CLIENT_ID     - Client ID ะดะปั HH API
CLIENT2_HH_API_URL       - ะะฐะทะพะฒัะน URL ะดะปั HH API
CLIENT2_WEBHOOK_URL_AVITO - URL ะดะปั webhook ัะฒะตะดะพะผะปะตะฝะธะน Avito
CLIENT2_WEBHOOK_URL_HH   - URL ะดะปั webhook ัะฒะตะดะพะผะปะตะฝะธะน HH
```

**ะัะธะผะตัะฐะฝะธั:** 
- Redis ะฟะฐัะพะปั ะณะตะฝะตัะธััะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะดะปั ะบะฐะถะดะพะณะพ ะบะปะธะตะฝัะฐ ะธ ะฝะต ััะตะฑัะตั ะฝะฐัััะพะนะบะธ
- Avito credentials (client_id, client_secret) ัะฟัะฐะฒะปััััั ัะตัะตะท API endpoints, ะฐ ะฝะต ัะตัะตะท ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
- `BASE_URL_AVITO` ะธ `BASE_URL_HH` ัะพะทะดะฐัััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพั ะดะพะผะตะฝะฐ:
  - `BASE_URL` = `https://ะดะพะผะตะฝ_ะบะปะธะตะฝัะฐ`
  - `BASE_URL_AVITO` = `https://ะดะพะผะตะฝ_ะบะปะธะตะฝัะฐ/avito`
  - `BASE_URL_HH` = `https://ะดะพะผะตะฝ_ะบะปะธะตะฝัะฐ/hh`
- ะะฐะถะดัะน ะบะปะธะตะฝั ะผะพะถะตั ะธะผะตัั ัะฒะพะน ัะฝะธะบะฐะปัะฝัะน ะดะพะผะตะฝ
- GitHub Actions ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟัะพะฒะตััะตั ะฝะฐะปะธัะธะต ะฒัะตั ะฝะตะพะฑัะพะดะธะผัั ัะตะบัะตัะพะฒ ะธ ะฟะตัะตะผะตะฝะฝัั ะฟะตัะตะด ะดะตะฟะปะพะตะผ

### 2. ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
project/
โโโ avito-main/                 # Avito ะฟัะธะปะพะถะตะฝะธะต
โโโ hh-main/                   # HH ะฟัะธะปะพะถะตะฝะธะต
โโโ docker-compose-universal.yml # ะฃะฝะธะฒะตััะฐะปัะฝัะน compose
โโโ ansible/
โ   โโโ deploy-universal.yml   # Ansible playbook
โ   โโโ run-universal-deploy.sh # ะกะบัะธะฟั ะดะปั ัััะฝะพะณะพ ะทะฐะฟััะบะฐ
โ   โโโ templates/
โ       โโโ env-universal.j2   # ะจะฐะฑะปะพะฝ .env ัะฐะนะปะฐ
โโโ .github/workflows/
    โโโ deploy.yml             # GitHub Action
```

## ๐ ะัะฟะพะปัะทะพะฒะฐะฝะธะต

### GitHub Actions (ะะตะบะพะผะตะฝะดัะตะผัะน ัะฟะพัะพะฑ)

1. ะะตัะตะนะดะธัะต ะฒ ัะฐะทะดะตะป **Actions** ะฒะฐัะตะณะพ ัะตะฟะพะทะธัะพัะธั
2. ะัะฑะตัะธัะต **Deploy Universal Application**
3. ะะฐะถะผะธัะต **Run workflow**
4. ะะฐะฟะพะปะฝะธัะต ะฟะฐัะฐะผะตััั:
   - **Domain**: `app.example.com`
   - **Server IP**: `192.168.1.100`
   - **Client Name**: `client1`
   - **Action**: `deploy` ะธะปะธ `update`

### ะััะฝะพะน ะทะฐะฟััะบ ัะตัะตะท Ansible

```bash
cd ansible
./run-universal-deploy.sh app.example.com 192.168.1.100 client1
```

### ะััะฝะพะน ะทะฐะฟััะบ ั ะฟะตัะตะผะตะฝะฝัะผะธ ะพะบััะถะตะฝะธั

```bash
# Redis password is generated automatically
export HH_CLIENT_ID="hh_client_id"
export HH_CLIENT_SECRET="hh_client_secret"
export WEBHOOK_URL="https://webhook.example.com"

cd ansible
./run-universal-deploy.sh app.example.com 192.168.1.100 client1
```

### ะััะฝะพะน ะทะฐะฟััะบ ั ะดะพะฟะพะปะฝะธัะตะปัะฝัะผะธ ะฟะฐัะฐะผะตััะฐะผะธ

```bash
cd ansible
./run-universal-deploy.sh app.example.com 192.168.1.100 client1 \
  "redis_password=mypass webhook_url=https://webhook.example.com"
```

## ๐ฑ API Endpoints

ะะพัะปะต ััะฟะตัะฝะพะณะพ ะดะตะฟะปะพั ะฑัะดัั ะดะพัััะฟะฝั:

- **Avito API**: `https://your-domain.com/avito/`
- **HH API**: `https://your-domain.com/hh/`
- **Portainer**: `https://your-domain.com/portainer/`
- **Traefik Dashboard**: `https://your-domain.com/traefik/`

## ๐ ะฃะฟัะฐะฒะปะตะฝะธะต ะบะปะธะตะฝัะฐะผะธ

### ะะตะฟะปะพะน ะฝะพะฒะพะณะพ ะบะปะธะตะฝัะฐ

```bash
# ะะปะธะตะฝั 1
./run-universal-deploy.sh app1.example.com 192.168.1.100 client1

# ะะปะธะตะฝั 2
./run-universal-deploy.sh app2.example.com 192.168.1.101 client2
```

### ะะฑะฝะพะฒะปะตะฝะธะต ัััะตััะฒัััะตะณะพ ะบะปะธะตะฝัะฐ

```bash
./run-universal-deploy.sh app.example.com 192.168.1.100 client1
```

## ๐ณ Docker ะบะพะฝัะตะนะฝะตัั

ะะฐะถะดัะน ะบะปะธะตะฝั ะฟะพะปััะฐะตั ะธะทะพะปะธัะพะฒะฐะฝะฝัะต ะบะพะฝัะตะนะฝะตัั:

- `avito-{client_name}` - Avito API ัะตัะฒะธั
- `hh-{client_name}` - HH API ัะตัะฒะธั  
- `redis-{client_name}` - Redis ะดะปั ะบะปะธะตะฝัะฐ
- `traefik` - ะะฑัะธะน reverse proxy
- `portainer` - ะะฑัะธะน Docker UI

## ๐ ะะตะทะพะฟะฐัะฝะพััั

- ะัะต ัะตะบัะตัั ััะฐะฝัััั ะฒ GitHub Secrets
- SSH ะดะพัััะฟ ัะพะปัะบะพ ะฟะพ ะบะปััะฐะผ
- Traefik ะฐะฒัะพะผะฐัะธัะตัะบะธ ะณะตะฝะตัะธััะตั SSL ัะตััะธัะธะบะฐัั
- ะะพะฝัะตะนะฝะตัั ะธะทะพะปะธัะพะฒะฐะฝั ะฟะพ ะบะปะธะตะฝัะฐะผ
- Redis ะทะฐัะธัะตะฝ ะฟะฐัะพะปะตะผ

## ๐๏ธ Troubleshooting

### ะัะพะฒะตัะบะฐ ััะฐัััะฐ ะบะพะฝัะตะนะฝะตัะพะฒ

```bash
ssh appuser@your-server
docker ps
```

### ะัะพัะผะพัั ะปะพะณะพะฒ

```bash
# Avito
docker logs avito-client1

# HH
docker logs hh-client1

# Redis
docker logs redis-client1
```

### ะะตัะตะทะฐะฟััะบ ัะตัะฒะธัะพะฒ

```bash
cd /home/appuser/app
docker-compose -f docker-compose-universal.yml restart
```

## ๐ ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### ะะตะฟะปะพะน ะดะปั ะบะปะธะตะฝัะฐ "company1"

```bash
./run-universal-deploy.sh api.company1.com 192.168.1.100 company1
```

### ะะตะฟะปะพะน ะดะปั ะบะปะธะตะฝัะฐ "startup2"

```bash
./run-universal-deploy.sh app.startup2.com 192.168.1.101 startup2
```

## ๐ ะะฑะฝะพะฒะปะตะฝะธะต

ะะปั ะพะฑะฝะพะฒะปะตะฝะธั ะฟัะธะปะพะถะตะฝะธั ะธัะฟะพะปัะทัะนัะต GitHub Action ั ะฟะฐัะฐะผะตััะพะผ **Action: update** ะธะปะธ ะฟะตัะตะทะฐะฟัััะธัะต ัะบัะธะฟั ั ัะตะผะธ ะถะต ะฟะฐัะฐะผะตััะฐะผะธ.

## ๐ ะะพะดะดะตัะถะบะฐ

ะัะธ ะฒะพะทะฝะธะบะฝะพะฒะตะฝะธะธ ะฟัะพะฑะปะตะผ:
1. ะัะพะฒะตัััะต ะปะพะณะธ ะบะพะฝัะตะนะฝะตัะพะฒ
2. ะฃะฑะตะดะธัะตัั, ััะพ ะฒัะต ัะตะบัะตัั ะฝะฐัััะพะตะฝั
3. ะัะพะฒะตัััะต ะดะพัััะฟะฝะพััั ัะตัะฒะตัะฐ
4. ะัะพะฒะตัััะต DNS ะฝะฐัััะพะนะบะธ ะดะพะผะตะฝะฐ
