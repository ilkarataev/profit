name: Deploy Application

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain name for deployment'
        required: true
        default: 'web.test.ru'
        type: string
      server_ip:
        description: 'Server IP address'
        required: true
        default: '46.62.213.224'
        type: string
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - setup
          - deploy
          - update

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Ansible
      run: |
        sudo apt-get update
        sudo apt-get install -y ansible
        ansible --version

    - name: Display deployment information
      run: |
        echo "========================================="
        echo "üöÄ DEPLOYMENT INFORMATION"
        echo "========================================="
        echo "üåê Domain: ${{ inputs.domain }}"
        echo "üîó IP Address: ${{ inputs.server_ip }}"
        echo "üîß Action: ${{ inputs.action }}"
        echo "========================================="

    - name: Create SSH key file
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub

    - name: Setup server
      if: ${{ inputs.action == 'setup' }}
      run: |
        cd ansible
        ansible-playbook -i "${{ inputs.server_ip }}," playbook-server.yml \
          --private-key=~/.ssh/id_rsa \
          -u root \
          -e "site_domain=${{ inputs.domain }}"
      env:
        ANSIBLE_HOST_KEY_CHECKING: False

    - name: Deploy application
      if: ${{ inputs.action == 'deploy' }}
      run: |
        cd ansible
        ansible-playbook -i "${{ inputs.server_ip }}," deploy-app.yml \
          --private-key=~/.ssh/id_rsa \
          -u appuser \
          -e "site_domain=${{ inputs.domain }}"
      env:
        ANSIBLE_HOST_KEY_CHECKING: False

    - name: Update application
      if: ${{ inputs.action == 'update' }}
      run: |
        cd ansible
        ansible-playbook -i "${{ inputs.server_ip }}," deploy-app.yml \
          --private-key=~/.ssh/id_rsa \
          -u appuser \
          -e "site_domain=${{ inputs.domain }}" \
          --tags update
      env:
        ANSIBLE_HOST_KEY_CHECKING: False

    - name: Notify deployment status
      if: always()
      run: |
        DOMAIN="${{ inputs.domain }}"
        ACTION="${{ inputs.action }}"
        IP="${{ inputs.server_ip }}"
        
        echo "========================================="
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ $ACTION successful!"
          echo "üåê Domain: https://$DOMAIN"
          echo "üîó IP Address: $IP"
          echo "üê≥ Portainer: https://$DOMAIN/portainer/"
          echo "üö¶ Traefik: https://$DOMAIN/traefik/"
          echo "========================================="
          echo "üìù Next steps:"
          echo "1. Check Portainer: https://$DOMAIN/portainer/"
          echo "2. Check Traefik: https://$DOMAIN/traefik/"
          echo "3. Deploy your application to: https://$DOMAIN/"
        else
          echo "‚ùå $ACTION failed!"
          echo "üîç Check the logs above for details"
        fi
        echo "========================================="

    - name: Cleanup SSH key
      if: always()
      run: |
        rm -f ~/.ssh/id_rsa ~/.ssh/id_rsa.pub
