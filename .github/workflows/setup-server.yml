name: Setup Server

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain name for deployment'
        required: true
        default: 'web.test.ru'
        type: string
      server_ip:
        description: 'Server IPv4 address'
        required: true
        default: '123.123.123.123'
        type: string

jobs:
  setup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Ansible
      run: |
        sudo apt-get update
        sudo apt-get install -y ansible
        ansible --version

    - name: Display setup information
      run: |
        echo "========================================="
        echo "ğŸš€ SERVER SETUP"
        echo "========================================="
        echo "ğŸŒ Domain: ${{ inputs.domain }}"
        echo "ğŸ”— IP Address: ${{ inputs.server_ip }}"
        echo "========================================="

    - name: Create SSH key file
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub

    - name: Setup server
      run: |
        cd ansible
        ansible-playbook -i "${{ inputs.server_ip }}," playbook-server.yml \
          --private-key=~/.ssh/id_rsa \
          -u root \
          -e "site_domain=${{ inputs.domain }}"
      env:
        ANSIBLE_HOST_KEY_CHECKING: False

    - name: Display setup completion
      if: always()
      run: |
        DOMAIN="${{ inputs.domain }}"
        IP="${{ inputs.server_ip }}"
        
        echo "========================================="
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Server setup successful!"
          echo "ğŸŒ Domain: https://$DOMAIN"
          echo "ğŸ”— IP Address: $IP"
          echo "ğŸ³ Portainer: https://$DOMAIN/portainer/"
          echo "ğŸš¦ Traefik: https://$DOMAIN/traefik/"
          echo "========================================="
          echo "ğŸ“ Next steps:"
          echo "1. Check Portainer: https://$DOMAIN/portainer/"
          echo "2. Check Traefik: https://$DOMAIN/traefik/"
          echo "3. Run 'Deploy Application' workflow to deploy your app"
        else
          echo "âŒ Server setup failed!"
          echo "ğŸ” Check the logs above for details"
        fi
        echo "========================================="

    - name: Cleanup SSH key
      if: always()
      run: |
        rm -f ~/.ssh/id_rsa ~/.ssh/id_rsa.pub
