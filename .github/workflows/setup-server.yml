name: Setup Server

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain name for server setup (DNS A record must point to server)'
        required: true
        default: 'web.test.ru'
        type: string

jobs:
  setup:
    runs-on: ubuntu-24.04
    container: ghcr.io/ansible/creator-ee:latest  # Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ EE Ğ¾Ğ±Ñ€Ğ°Ğ·

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install required packages
      run: |
        apk add --no-cache bind-tools iputils
        which dig
        dig --version

    - name: Install Ansible collections
      run: |
        ansible-galaxy collection install -r ansible/requirements.yml

    - name: Check DNS resolution
      run: |
        echo "ğŸ” Checking DNS resolution for ${{ inputs.domain }}..."
        # Try dig first, then nslookup as fallback
        if command -v dig >/dev/null 2>&1; then
          DNS_IP=$(dig +short ${{ inputs.domain }} | head -n1)
        else
          echo "dig not found, trying nslookup..."
          DNS_IP=$(nslookup ${{ inputs.domain }} | grep -A1 "Name:" | grep "Address:" | awk '{print $2}' | head -n1)
        fi
        
        if [ -z "$DNS_IP" ]; then
          echo "âŒ DNS record for ${{ inputs.domain }} not found!"
          echo "Please configure DNS A record pointing to your server"
          echo "::error::DNS resolution failed for ${{ inputs.domain }}"
          exit 1
        else
          echo "âœ… DNS: ${{ inputs.domain }} -> $DNS_IP"
        fi

    - name: Check server connectivity
      run: |
        echo "ğŸ” Checking server connectivity..."
        if ping -c 1 ${{ inputs.domain }} > /dev/null 2>&1; then
          echo "âœ… Server is reachable"
        else
          echo "âŒ Server is not reachable via ping"
          echo "Please ensure server is running and accessible"
          echo "::error::Server connectivity check failed for ${{ inputs.domain }}"
          exit 1
        fi

    - name: Display setup information
      run: |
        echo "========================================="
        echo "ğŸš€ SERVER SETUP"
        echo "========================================="
        echo "ğŸŒ Domain: ${{ inputs.domain }}"
        echo "ğŸ”— DNS IP: $(dig +short ${{ inputs.domain }} | head -n1)"
        echo "========================================="

    - name: Start SSH agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Setup server
      run: |
        cd ansible
        ansible-playbook -i "${{ inputs.domain }}," playbook-server.yml \
          -u root \
          -e "site_domain=${{ inputs.domain }}"
      env:
        ANSIBLE_HOST_KEY_CHECKING: False

    - name: Display setup completion
      if: always()
      run: |
        DOMAIN="${{ inputs.domain }}"
        
        echo "========================================="
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Server setup successful!"
          echo "ğŸŒ Domain: https://$DOMAIN"
          echo "ğŸ³ Portainer: https://$DOMAIN/portainer/"
          echo "ğŸš¦ Traefik: https://$DOMAIN/traefik/"
          echo "========================================="
          echo "ğŸ“ Next steps:"
          echo "1. Check Portainer: https://$DOMAIN/portainer/"
          echo "2. Check Traefik: https://$DOMAIN/traefik/"
          echo "3. Run 'Deploy Application' workflow to deploy your app"
        else
          echo "âŒ Server setup failed!"
          echo "ğŸ” Check the logs above for details"
          echo "ğŸ’¡ Make sure:"
          echo "   - DNS A record points to this server"
          echo "   - SSH key is properly configured"
          echo "   - Server is accessible"
        fi
        echo "========================================="

