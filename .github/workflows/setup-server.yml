name: Setup Server

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain name for server setup (DNS A record must point to server)'
        required: true
        default: 'web.test.ru'
        type: string

jobs:
  setup:
    runs-on: ubuntu-24.04
    container: ghcr.io/ansible/creator-ee:latest  # официальный EE образ

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Ansible collections
      run: |
        ansible-galaxy collection install -r ansible/requirements.yml

    - name: Check DNS resolution
      run: |
        echo "🔍 Checking DNS resolution for ${{ inputs.domain }}..."
        DNS_IP=$(dig +short ${{ inputs.domain }} | head -n1)
        if [ -z "$DNS_IP" ]; then
          echo "❌ DNS record for ${{ inputs.domain }} not found!"
          echo "Please configure DNS A record pointing to your server"
          echo "::error::DNS resolution failed for ${{ inputs.domain }}"
          exit 1
        else
          echo "✅ DNS: ${{ inputs.domain }} -> $DNS_IP"
        fi

    - name: Check server connectivity
      run: |
        echo "🔍 Checking server connectivity..."
        if ping -c 1 ${{ inputs.domain }} > /dev/null 2>&1; then
          echo "✅ Server is reachable"
        else
          echo "❌ Server is not reachable via ping"
          echo "Please ensure server is running and accessible"
          echo "::error::Server connectivity check failed for ${{ inputs.domain }}"
          exit 1
        fi

    - name: Display setup information
      run: |
        echo "========================================="
        echo "🚀 SERVER SETUP"
        echo "========================================="
        echo "🌐 Domain: ${{ inputs.domain }}"
        echo "🔗 DNS IP: $(dig +short ${{ inputs.domain }} | head -n1)"
        echo "========================================="

    - name: Start SSH agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Setup server
      run: |
        cd ansible
        ansible-playbook -i "${{ inputs.domain }}," playbook-server.yml \
          -u root \
          -e "site_domain=${{ inputs.domain }}"
      env:
        ANSIBLE_HOST_KEY_CHECKING: False

    - name: Display setup completion
      if: always()
      run: |
        DOMAIN="${{ inputs.domain }}"
        
        echo "========================================="
        if [ ${{ job.status }} == 'success' ]; then
          echo "✅ Server setup successful!"
          echo "🌐 Domain: https://$DOMAIN"
          echo "🐳 Portainer: https://$DOMAIN/portainer/"
          echo "🚦 Traefik: https://$DOMAIN/traefik/"
          echo "========================================="
          echo "📝 Next steps:"
          echo "1. Check Portainer: https://$DOMAIN/portainer/"
          echo "2. Check Traefik: https://$DOMAIN/traefik/"
          echo "3. Run 'Deploy Application' workflow to deploy your app"
        else
          echo "❌ Server setup failed!"
          echo "🔍 Check the logs above for details"
          echo "💡 Make sure:"
          echo "   - DNS A record points to this server"
          echo "   - SSH key is properly configured"
          echo "   - Server is accessible"
        fi
        echo "========================================="

