name: Setup Server

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain name for server setup (DNS A record must point to server)'
        required: true
        default: 'web.test.ru'
        type: string

jobs:
  setup:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check DNS resolution
      run: |
        echo "üîç Checking DNS resolution for ${{ inputs.domain }}..."
        DNS_IP=$(dig +short ${{ inputs.domain }} | head -n1)
        if [ -z "$DNS_IP" ]; then
          echo "‚ùå DNS record for ${{ inputs.domain }} not found!"
          echo "Please configure DNS A record pointing to your server"
          echo "::error::DNS resolution failed for ${{ inputs.domain }}"
          exit 1
        else
          echo "‚úÖ DNS: ${{ inputs.domain }} -> $DNS_IP"
        fi

    - name: Check server connectivity
      run: |
        echo "üîç Checking server connectivity..."
        if ping -c 1 ${{ inputs.domain }} > /dev/null 2>&1; then
          echo "‚úÖ Server is reachable"
        else
          echo "‚ö†Ô∏è  Server is not reachable via ping (this is normal for some networks)"
          echo "‚ÑπÔ∏è  Continuing with deployment - SSH connection will be tested during Ansible run"
        fi

    - name: Run Ansible with container
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          -e ANSIBLE_HOST_KEY_CHECKING=False \
          ghcr.io/ansible/creator-ee:latest \
          ansible-galaxy collection install -r ansible/requirements.yml

    - name: Display setup information
      run: |
        echo "========================================="
        echo "üöÄ SERVER SETUP"
        echo "========================================="
        echo "üåê Domain: ${{ inputs.domain }}"
        echo "üîó DNS IP: $(dig +short ${{ inputs.domain }} | head -n1)"
        echo "========================================="
        echo "‚ÑπÔ∏è  Note: If ping fails, this is normal for some networks"
        echo "‚ÑπÔ∏è  SSH connection will be tested during Ansible execution"
        echo "========================================="

    - name: Setup server
      run: |
        # Create SSH key file
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Run Ansible playbook with container
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -v ~/.ssh:/root/.ssh:ro \
          -w /workspace/ansible \
          -e ANSIBLE_HOST_KEY_CHECKING=False \
          ghcr.io/ansible/creator-ee:latest \
          ansible-playbook -i "${{ inputs.domain }}," playbook-server.yml \
            --private-key=/root/.ssh/id_rsa \
            -u root \
            -e "site_domain=${{ inputs.domain }}"

    - name: Display setup completion
      if: always()
      run: |
        DOMAIN="${{ inputs.domain }}"
        
        echo "========================================="
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ Server setup successful!"
          echo "üåê Domain: https://$DOMAIN"
          echo "üê≥ Portainer: https://$DOMAIN/portainer/"
          echo "üö¶ Traefik: https://$DOMAIN/traefik/"
          echo "========================================="
          echo "üìù Next steps:"
          echo "1. Check Portainer: https://$DOMAIN/portainer/"
          echo "2. Check Traefik: https://$DOMAIN/traefik/"
          echo "3. Run 'Deploy Application' workflow to deploy your app"
        else
          echo "‚ùå Server setup failed!"
          echo "üîç Check the logs above for details"
          echo "üí° Make sure:"
          echo "   - DNS A record points to this server"
          echo "   - SSH key is properly configured"
          echo "   - Server is accessible"
        fi
        echo "========================================="

    - name: Cleanup SSH key
      if: always()
      run: |
        rm -f ~/.ssh/id_rsa ~/.ssh/id_rsa.pub

